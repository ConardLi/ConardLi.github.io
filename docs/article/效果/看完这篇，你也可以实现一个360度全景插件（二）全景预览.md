---
title: çœ‹å®Œè¿™ç¯‡ï¼Œä½ ä¹Ÿå¯ä»¥å®žçŽ°ä¸€ä¸ª360åº¦å…¨æ™¯æ’ä»¶ï¼ˆäºŒï¼‰å…¨æ™¯é¢„è§ˆ
date: 2019-05-05 09:17:16
tags:
     - ç‰¹æ•ˆ
---


## ä¸‰ã€å…¨æ™¯é¢„è§ˆ


![](http://conardli.top/img/qj/qj_11_qj.gif)

### 3.1 åŸºæœ¬é€»è¾‘

- å°†ä¸€å¼ å…¨æ™¯å›¾åŒ…è£¹åœ¨çƒä½“çš„å†…å£

- è®¾å®šä¸€ä¸ªè§‚å¯Ÿç‚¹ï¼Œåœ¨çƒçš„åœ†å¿ƒ

- ä½¿ç”¨é¼ æ ‡å¯ä»¥æ‹–åŠ¨çƒä½“ï¼Œä»Žè€Œæ”¹å˜æˆ‘ä»¬çœ‹åˆ°å…¨æ™¯çš„è§†é‡Ž

- é¼ æ ‡æ»šè½®å¯ä»¥ç¼©æ”¾ï¼Œå’Œæ”¾å¤§ï¼Œæ”¹å˜è§‚å¯Ÿå…¨æ™¯çš„è¿œè¿‘

- æ ¹æ®åæ ‡åœ¨å…¨æ™¯å›¾ä¸ŠæŒ‚è½½ä¸€äº›æ ‡è®°ï¼Œå¦‚æ–‡å­—ã€å›¾æ ‡ç­‰ï¼Œå¹¶ä¸”å¯ä»¥å¢žåŠ äº‹ä»¶ï¼Œå¦‚ç‚¹å‡»äº‹ä»¶

### 3.2 åˆå§‹åŒ–

æˆ‘ä»¬å…ˆæŠŠå¿…è¦çš„åŸºç¡€è®¾æ–½æ­å»ºèµ·æ¥ï¼š

åœºæ™¯ã€ç›¸æœºï¼ˆé€‰æ‹©è¿œæ™¯ç›¸æœºï¼Œè¿™æ ·å¯ä»¥è®©å…¨æ™¯çœ‹èµ·æ¥æ›´çœŸå®žï¼‰ã€æ¸²æŸ“å™¨ï¼š

```js

_scene = new THREE.Scene();
initCamera();
initRenderer();
animate();

// åˆå§‹åŒ–ç›¸æœº
function initCamera() {
    _camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1100);
    _camera.position.set(0, 0, 2000);
    _camera.lookAt(new THREE.Vector3(0, 0, 0));
}

// åˆå§‹åŒ–æ¸²æŸ“å™¨
function initRenderer() {
    _renderer = new THREE.WebGLRenderer();
    _renderer.setSize(window.innerWidth, window.innerHeight);
    _container = document.getElementById('panoramaConianer');
    _container.appendChild(_renderer.domElement);
}

// å®žæ—¶æ¸²æŸ“
function animate() {
    requestAnimationFrame(animate);
    _renderer.render(_scene, _camera);
}
```

ä¸‹é¢æˆ‘ä»¬åœ¨åœºæ™¯å†…æ·»åŠ ä¸€ä¸ªçƒä½“ï¼Œå¹¶æŠŠå…¨æ™¯å›¾ä½œä¸ºææ–™åŒ…è£¹åœ¨çƒä½“ä¸Šé¢ï¼š

```js
var mesh = new THREE.Mesh(new THREE.SphereGeometry(1000, 100, 100),
new THREE.MeshBasicMaterial(
        { map: ImageUtils.loadTexture('img/p3.png') }
    ));
_scene.add(mesh);
```

ç„¶åŽæˆ‘ä»¬çœ‹åˆ°çš„åœºæ™¯åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š


![](http://conardli.top/img/qj/qj_12_qj.png)

è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæžœï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ä»Žçƒçš„å†…éƒ¨è§‚å¯Ÿå…¨æ™¯ï¼Œå¹¶ä¸”å…¨æ™¯å›¾æ˜¯é™„ç€å¤–çƒçš„å†…å£çš„ï¼Œè€Œä¸æ˜¯é“ºåœ¨å¤–é¢ï¼š

æˆ‘ä»¬åªè¦éœ€å°†`Material`çš„`scale`çš„ä¸€ä¸ªå±žæ€§è®¾ç½®ä¸ºè´Ÿå€¼ï¼Œææ–™å³å¯é™„ç€åœ¨å‡ ä½•ä½“çš„å†…éƒ¨ï¼š

```js
 mesh.scale.x = -1;
```

ç„¶åŽæˆ‘ä»¬å°†ç›¸æœºçš„ä¸­å¿ƒç‚¹ç§»åŠ¨åˆ°çƒçš„ä¸­å¿ƒï¼š

```js
 _camera.position.set(0, 0, 0);
```

çŽ°åœ¨æˆ‘ä»¬å·²ç»åœ¨å…¨æ™¯çƒçš„å†…éƒ¨å•¦ï¼š


![](http://conardli.top/img/qj/qj_13_qj.png)


### 3.3 äº‹ä»¶å¤„ç†

å…¨æ™¯å›¾å·²ç»å¯ä»¥æµè§ˆäº†ï¼Œä½†æ˜¯ä½ åªèƒ½çœ‹åˆ°ä½ çœ¼å‰çš„è¿™ä¸€å—ï¼Œå¹¶ä¸èƒ½æ‹–åŠ¨å®ƒçœ‹åˆ°å…¶ä»–éƒ¨åˆ†ï¼Œä¸ºäº†ç²¾ç¡®çš„æŽ§åˆ¶æ‹–åŠ¨çš„é€Ÿåº¦å’Œç¼©æ”¾ã€æ”¾å¤§ç­‰åœºæ™¯ï¼Œæˆ‘ä»¬æ‰‹åŠ¨ä¸ºå®ƒå¢žåŠ ä¸€äº›äº‹ä»¶ï¼š

ç›‘å¬é¼ æ ‡çš„`mousedown`äº‹ä»¶ï¼Œåœ¨æ­¤æ—¶å°†å¼€å§‹æ‹–åŠ¨æ ‡è®°`_isUserInteracting`è®¾ç½®ä¸º`true`ï¼Œå¹¶ä¸”è®°å½•èµ·å§‹çš„å±å¹•åæ ‡ï¼Œä»¥åŠèµ·å§‹çš„ç›¸æœº`lookAt`çš„åæ ‡ã€‚

```js
_container.addEventListener('mousedown', (event)=>{
  event.preventDefault();
  _isUserInteracting = true;
  _onPointerDownPointerX = event.clientX;
  _onPointerDownPointerY = event.clientY;
  _onPointerDownLon = _lon;
  _onPointerDownLat = _lat;
});
```

ç›‘å¬é¼ æ ‡çš„`mousemove`äº‹ä»¶ï¼Œå½“`_isUserInteracting`ä¸º`true`æ—¶ï¼Œå®žæ—¶è®¡ç®—å½“å‰ç›¸æœº`lookAt`çš„çœŸå®žåæ ‡ã€‚

```js
_container.addEventListener('mousemove', (event)=>{
  if (_isUserInteracting) {
    _lon = (_onPointerDownPointerX - event.clientX) * 0.1 + _onPointerDownLon;
    _lat = (event.clientY - _onPointerDownPointerY) * 0.1 + _onPointerDownLat;
  }
});
```
ç›‘å¬é¼ æ ‡çš„`mouseup`äº‹ä»¶ï¼Œå°†`_isUserInteracting`è®¾ç½®ä¸º`false`ã€‚

```js
_container.addEventListener('mouseup', (event)=>{
 _isUserInteracting = false;
});
```

å½“ç„¶ï¼Œä¸Šé¢æˆ‘ä»¬åªæ˜¯æ”¹å˜äº†åæ ‡ï¼Œå¹¶æ²¡æœ‰å‘Šè¯‰ç›¸æœºå®ƒæ”¹å˜äº†ï¼Œæˆ‘ä»¬åœ¨`animate`å‡½æ•°ä¸­æ¥åšè¿™ä»¶äº‹ï¼š

```js
function animate() {
  requestAnimationFrame(animate);
  calPosition();
  _renderer.render(_scene, _camera);
  _renderer.render(_sceneOrtho, _cameraOrtho);
}

function calPosition() {
  _lat = Math.max(-85, Math.min(85, _lat));
  var phi = tMath.degToRad(90 - _lat);
  var theta = tMath.degToRad(_lon);
  _camera.target.x = _pRadius * Math.sin(phi) * Math.cos(theta);
  _camera.target.y = _pRadius * Math.cos(phi);
  _camera.target.z = _pRadius * Math.sin(phi) * Math.sin(theta);
  _camera.lookAt(_camera.target);
}

```

ç›‘å¬`mousewheel`äº‹ä»¶ï¼Œå¯¹å…¨æ™¯å›¾è¿›è¡Œæ”¾å¤§å’Œç¼©å°ï¼Œæ³¨æ„è¿™é‡ŒæŒ‡å®šäº†æœ€å¤§ç¼©æ”¾èŒƒå›´`maxFocalLength`å’Œæœ€å°ç¼©æ”¾èŒƒå›´`minFocalLength`ã€‚

```js
_container.addEventListener('mousewheel', (event)=>{
  var ev = ev || window.event;
  var down = true;
  var m = _camera.getFocalLength();
  down = ev.wheelDelta ? ev.wheelDelta < 0 : ev.detail > 0;
  if (down) {
    if (m > minFocalLength) {
      m -= m * 0.05
      _camera.setFocalLength(m);
    }
  } else {
    if (m < maxFocalLength) {
      m += m * 0.05
      _camera.setFocalLength(m);
    }
  }
});
```
æ¥çœ‹ä¸€ä¸‹æ•ˆæžœå§ï¼š


![](http://conardli.top/img/qj/qj_16_qj.gif)

### 3.4 å¢žåŠ æ ‡è®°

åœ¨æµè§ˆå…¨æ™¯å›¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å¯¹æŸäº›ç‰¹æ®Šçš„ä½ç½®è¿›è¡Œä¸€äº›æ ‡è®°ï¼Œå¹¶ä¸”è¿™äº›æ ‡è®°å¯èƒ½é™„å¸¦ä¸€äº›äº‹ä»¶ï¼Œæ¯”å¦‚ä½ éœ€è¦ç‚¹å‡»ä¸€ä¸ªæ ‡è®°æ‰èƒ½åˆ°è¾¾ä¸‹ä¸€å¼ å…¨æ™¯å›¾ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨å…¨æ™¯ä¸­å¢žåŠ æ ‡è®°ï¼Œä»¥åŠå¦‚ä½•ä¸ºè¿™äº›æ ‡è®°æ·»åŠ äº‹ä»¶ã€‚

æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦è®©è¿™äº›æ ‡è®°éšç€è§†é‡Žçš„å˜åŒ–è€Œæ”¾å¤§å’Œç¼©å°ï¼ŒåŸºäºŽæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£äº¤æŠ•å½±ç›¸æœºæ¥å±•çŽ°æ ‡è®°ï¼Œåªéœ€ç»™å®ƒä¸€ä¸ªå›ºå®šçš„è§‚å¯Ÿé«˜åº¦ï¼š

```js
  _cameraOrtho = new THREE.OrthographicCamera(-window.innerWidth / 2, window.innerWidth / 2, window.innerHeight / 2, -window.innerHeight / 2, 1, 10);
  _cameraOrtho.position.z = 10;
  _sceneOrtho = new Scene();
```

åˆ©ç”¨ç²¾çµææ–™(`SpriteMaterial`)æ¥å®žçŽ°æ–‡å­—æ ‡è®°ï¼Œæˆ–è€…å›¾ç‰‡æ ‡è®°ï¼š

```js
// åˆ›å»ºæ–‡å­—æ ‡è®°
function createLableSprite(name) {
  const canvas = document.createElement('canvas');
  const context = canvas.getContext('2d');
  const metrics = context.measureText(name);
  const width = metrics.width * 1.5;
  context.font = "10px å®‹ä½“";
  context.fillStyle = "rgba(0,0,0,0.95)";
  context.fillRect(2, 2, width + 4, 20 + 4);
  context.fillText(name, 4, 20);
  const texture = new Texture(canvas);
  const spriteMaterial = new SpriteMaterial({ map: texture });
  const sprite = new Sprite(spriteMaterial);
  sprite.name = name;
  const lable = {
    name: name,
    canvas: canvas,
    context: context,
    texture: texture,
    sprite: sprite
  };
  _sceneOrtho.add(lable.sprite);
  return lable;
}
// åˆ›å»ºå›¾ç‰‡æ ‡è®°
function createSprite(position, url, name) {
  const textureLoader = new TextureLoader();
  const ballMaterial = new SpriteMaterial({
    map: textureLoader.load(url)
  });
  const sp = {
    pos: position,
    name: name,
    sprite: new Sprite(ballMaterial)
  };
  sp.sprite.scale.set(32, 32, 1.0);
  sp.sprite.name = name;
  _sceneOrtho.add(sp.sprite);
  return sp;
}
```

åˆ›å»ºå¥½è¿™äº›æ ‡è®°ï¼Œæˆ‘ä»¬æŠŠå®ƒæ¸²æŸ“åˆ°åœºæ™¯ä¸­ã€‚

æˆ‘ä»¬å¿…é¡»å‘Šè¯‰åœºæ™¯è¿™äº›æ ‡è®°çš„ä½ç½®ï¼Œä¸ºäº†ç›´è§‚çš„ç†è§£ï¼Œæˆ‘ä»¬éœ€è¦ç»™è¿™äº›æ ‡è®°èµ‹äºˆä¸€ç§åæ ‡ï¼Œè¿™ç§åæ ‡å¾ˆç±»ä¼¼äºŽç»çº¬åº¦ï¼Œæˆ‘ä»¬å«å®ƒ`lon`å’Œ`lat`ï¼Œå…·ä½“æ˜¯å¦‚ä½•ç»™å®šçš„æˆ‘ä»¬åœ¨ä¸‹é¢çš„ç« èŠ‚ï¼š[å…¨æ™¯æ ‡è®°](#å…¨æ™¯æ ‡è®°)ä¸­ä¼šè¯¦ç»†ä»‹ç»ã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸€å…±ç»åŽ†äº†ä¸¤æ¬¡åæ ‡è½¬æ¢ï¼š

ç¬¬ä¸€æ¬¡è½¬æ¢ï¼šå°†â€œç»çº¬åº¦â€è½¬æ¢ä¸ºä¸‰ç»´ç©ºé—´åæ ‡ï¼Œå³æˆ‘ä»¬ä¸Šé¢è®²çš„é‚£ç§`xã€yã€z`å½¢å¼çš„åæ ‡ã€‚

ä½¿ç”¨`geoPosition2World`å‡½æ•°è¿›è¡Œè½¬æ¢ï¼Œå¾—åˆ°ä¸€ä¸ª`Vector3`å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å½“å‰ç›¸æœº`_camera`ä½œä¸ºå‚æ•°ä¼ å…¥è¿™ä¸ªå¯¹è±¡çš„`project`æ–¹æ³•ï¼Œè¿™ä¼šå¾—åˆ°ä¸€ä¸ªæ ‡å‡†åŒ–åŽçš„åæ ‡ï¼ŒåŸºäºŽè¿™ä¸ªåæ ‡å¯ä»¥å¸®æˆ‘ä»¬åˆ¤æ–­æ ‡è®°æ˜¯å¦åœ¨è§†é‡ŽèŒƒå›´å†…ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ï¼Œè‹¥æ ‡å‡†åŒ–åæ ‡åœ¨`-1`å’Œ`1`çš„èŒƒå›´å†…ï¼Œåˆ™å®ƒä¼šå‡ºçŽ°åœ¨æˆ‘ä»¬çš„è§†é‡Žä¸­ï¼Œæˆ‘ä»¬å°†å®ƒè¿›è¡Œå‡†ç¡®æ¸²æŸ“ã€‚

ç¬¬äºŒæ¬¡è½¬æ¢ï¼šå°†ä¸‰ç»´ç©ºé—´åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡ã€‚

å¦‚æžœæˆ‘ä»¬ç›´æŽ¥è®²ä¸Šé¢çš„ä¸‰ç»´ç©ºé—´åæ ‡åæ ‡åº”ç”¨åˆ°æ ‡è®°ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘çŽ°æ— è®ºè§†é‡Žå¦‚ä½•ç§»åŠ¨ï¼Œæ ‡è®°çš„ä½ç½®æ˜¯ä¸ä¼šæœ‰ä»»ä½•å˜åŒ–çš„ï¼Œå› ä¸ºè¿™æ ·ç®—å‡ºæ¥çš„åæ ‡æ°¸è¿œæ˜¯ä¸€ä¸ªå¸¸é‡ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸Šé¢çš„æ ‡å‡†åŒ–åæ ‡ï¼Œå°†æ ‡è®°çš„ä¸‰ç»´ç©ºé—´åæ ‡è½¬æ¢ä¸ºçœŸå®žçš„å±å¹•åæ ‡ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯`worldPostion2Screen`å‡½æ•°æ¥å®žçŽ°çš„ã€‚

å…³äºŽ`geoPosition2World`å’Œ`worldPostion2Screen`ä¸¤ä¸ªå‡½æ•°çš„å®žçŽ°ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥åŽ»æˆ‘çš„`github`æºç ä¸­æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸å¤šåšè§£é‡Šäº†ï¼Œå› ä¸ºè¿™åˆè¦ç‰µæ‰¯åˆ°ä¸€å¤§å †ä¸“ä¸šçŸ¥è¯†å•¦ã€‚ðŸ˜…

```js
var wp = geoPosition2World(_sprites.lon, _sprites.lat);
var sp = worldPostion2Screen(wp, _camera);
var test = wp.clone();
test.project(_camera);
if (test.x > -1 && test.x < 1 && test.y > -1 && test.y < 1 && test.z > -1 && test.z < 1) {
    _sprites[i].sprite.scale.set(32, 32, 32);
    _sprites[i].sprite.position.set(sp.x, sp.y, 1);
}else {
    _sprites[i].sprite.scale.set(1.0, 1.0, 1.0);
    _sprites[i].sprite.position.set(0, 0, 0);
}
```


![](http://conardli.top/img/qj/qj_14_qj.png)

çŽ°åœ¨ï¼Œæ ‡è®°å·²ç»æ·»åŠ åˆ°å…¨æ™¯ä¸Šé¢äº†ï¼Œæˆ‘ä»¬æ¥ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼š

`Three.js`å¹¶æ²¡æœ‰å•ç‹¬æä¾›ä¸º`Sprite`æ·»åŠ äº‹ä»¶çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©å…‰çº¿æŠ•å°„å™¨ï¼ˆ`Raycaster`ï¼‰æ¥å®žçŽ°ã€‚

`Raycaster`æä¾›äº†é¼ æ ‡æ‹¾å–çš„èƒ½åŠ›ï¼š

é€šè¿‡`setFromCamera`å‡½æ•°æ¥å»ºç«‹å½“å‰ç‚¹å‡»çš„åæ ‡ï¼ˆç»è¿‡å½’ä¸€åŒ–å¤„ç†ï¼‰å’Œç›¸æœºçš„ç»‘å®šå…³ç³»ã€‚

é€šè¿‡`intersectObjects`æ¥åˆ¤å®šä¸€ç»„å¯¹è±¡ä¸­æœ‰å“ªäº›è¢«å‘½ä¸­ï¼ˆç‚¹å‡»ï¼‰ï¼Œå¾—åˆ°è¢«å‘½ä¸­çš„å¯¹è±¡æ•°ç»„ã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥èŽ·å–åˆ°ç‚¹å‡»çš„å¯¹è±¡ï¼Œå¹¶åŸºäºŽå®ƒåšä¸€äº›å¤„ç†ï¼š

```js
_container.addEventListener('click', (event)=>{
  _mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  _mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  _raycaster.setFromCamera(_mouse, _cameraOrtho);
  var intersects = _raycaster.intersectObjects(_clickableObjects);
  intersects.forEach(function (element) {
    alert("ç‚¹å‡»åˆ°äº†: " + element.object.name);
  });
});
```

ç‚¹å‡»åˆ°ä¸€ä¸ªæ ‡è®°ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€å¼ å…¨æ™¯å›¾ï¼š


![](http://conardli.top/img/qj/qj_15_qj.gif)

æ–‡ä¸­å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿Žåœ¨è¯„è®ºåŒºæŒ‡æ­£ï¼Œå¦‚æžœè¿™ç¯‡æ–‡ç« å¸®åŠ©åˆ°äº†ä½ ï¼Œæ¬¢è¿Žç‚¹èµžå’Œå…³æ³¨ã€‚